<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lighting Quality Selection</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: white; font-family: 'IBM Plex Sans Arabic', sans-serif; }
    .modal-body p { margin-bottom: 0.5rem; }
    .param-box { padding: 10px; border: 1px solid #444; border-radius: 10px; margin-bottom: 10px; }
  </style>
</head>
<body class="p-4">

  <div class="container my-5">
    <div class="card bg-secondary text-white p-4 rounded-4">
      <h3 class="text-center mb-4 text-warning">Start Lighting Simulation</h3>
      <form id="selectionForm">
        <div class="row g-4">
          <div class="col-md-6">
            <label for="ageSelect" class="form-label">Select Age Group</label>
            <select class="form-select" id="ageSelect" required>
              <option value="" disabled selected>Choose age group</option>
              <option value="kinder">Kindergarten</option>
              <option value="primary">Primary</option>
              <option value="adults">Adults</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="envSelect" class="form-label">Select Environment</label>
            <select class="form-select" id="envSelect" required>
              <option value="" disabled selected>Choose environment</option>
              <option value="classroom">Classroom</option>
              <option value="playground">Playground</option>
              <option value="laboratory">Laboratory</option>
            </select>
          </div>
        </div>
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-danger btn-lg">Simulate</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Recommendation Modal -->
  <div class="modal fade" id="recommendationModal" tabindex="-1" aria-labelledby="recommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content bg-dark text-white rounded-4 border-light">
        <div class="modal-header">
          <h5 class="modal-title text-warning" id="recommendationModalLabel">Recommended Lighting Parameters</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="recommendationContent">
          <!-- Filled dynamically -->
        </div>
        <div class="modal-footer">
          <a href="class2.html" class="btn btn-outline-light">Go to Manual Simulator</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Main Script -->
  <script>
    const form = document.getElementById('selectionForm');
    const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
    const modalBody = document.getElementById('recommendationContent');

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const grade = document.getElementById('ageSelect').value;
      const env = document.getElementById('envSelect').value;

      if (!grade || !env) {
        alert('Please select both age group and environment.');
        return;
      }

      // Save to cookies
      document.cookie = `selectedGrade=${grade}; path=/; max-age=3600`;
      document.cookie = `selectedEnvironment=${env}; path=/; max-age=3600`;

      try {
        // Replace with your actual API URL
        const res = await fetch('api/lighting_recommendations_by_age_env.json');
        const data = await res.json();
        const rec = data[grade];

        let html = `
          <div class="text-center mb-3">
            <img src="${rec.image}" alt="Age image" class="img-fluid rounded" style="max-height: 200px;">
            <p class="mt-2 text-muted">Age Range: ${rec.age_range} | Environment: ${env}</p>
          </div>
        `;

        const levels = rec.recommendation_levels;
        for (const levelName in levels) {
          const envParams = levels[levelName].environments[env];
          if (!envParams) continue;

          html += `<h5 class="mt-4 text-capitalize">${levelName.replace('_', ' ')}</h5>`;
          for (const param in envParams) {
            const p = envParams[param];
            html += `
              <div class="param-box">
                <strong>${param}</strong><br>
                Range: ${p.range.min} - ${p.range.max} ${p.range.unit}<br>
                <em>Reason:</em> ${p.reason}<br>
                <em>Recommendation:</em> ${p.recommendation}
              </div>
            `;
          }
        }

        modalBody.innerHTML = html;
        modal.show();

      } catch (err) {
        console.error(err);
        modalBody.innerHTML = `<div class="alert alert-danger">Failed to fetch data.</div>`;
        modal.show();
      }
    });
  </script>
</body>
</html>
